<html layout:decorate="~{layout/default}">
<head>
    <meta charset='utf-8'/>
    <!--fullcalendar-->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <!--google calendar-->
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.11/index.global.min.js'></script>
    <script src='fullcalendar/dist/index.global.js'></script>
</head>
<body>
<div layout:fragment="content" class="container-fluid">
    <div class="row d-flex align-items-stretch">
        <!-- 달력 카드 -->
        <div class="col-md-6">

            <!-- Full Calendar -->

            <div class="card shadow mb-4">

                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">

                    <h6 class="m-0 font-weight-bold text-primary">일정 관리</h6>

                </div>

                <div class="card-body mb-12">
                    <div id="calendar" class="fc fc-media-screen fc-direction-ltr fc-theme-standard"></div>
                </div>
                <!-- 모달 창 -->
                <div class="modal fade" id="editEventModal" tabindex="-1" role="dialog" aria-labelledby="editEventModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editEventModalLabel">이벤트 수정</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form>
                                    <div class="form-group">
                                        <label for="eventTitleInput">내용</label>
                                        <input type="text" class="form-control" id="eventTitleInput">
                                    </div>
                                    <label for="eventColorSelect">색깔</label>
                                    <select class="form-control" id="eventColorSelect">
                                        <option value="red">빨강</option>
                                        <option value="yellow">노랑</option>
                                        <option value="green">초록</option>
                                        <option value="blue">파랑</option>
                                        <option value="aqua">하늘</option>
                                        <option value="silver">실버</option>
                                        <!-- 원하는 다른 색상을 추가할 수 있습니다. -->
                                    </select>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" id="editEventModalConfirm">확인</button>
                                <button type="button" class="btn btn-warning" id="editEventModalDelete">삭제</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
        <div class="col-md-6">
            <script layout:fragment="script" type='text/javascript'>
                document.addEventListener('DOMContentLoaded', function() {
                    var calendarEl = document.getElementById('calendar');
                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        locale: 'ko',
                        googleCalendarApiKey : "AIzaSyBpL3vEBHMwFcrnYFMKpQmvPkSqZw1mXnQ",
                        //드래그 버튼
                        initialView: 'dayGridMonth',
                        selectable: true,
                        //헤더툴바
                        headerToolbar:{
                            start: 'today',
                            center: 'title',
                            end: 'prev,next'
                        },
                        editable: true,
                        selectable: true,
                        businessHours: true,
                        dayMaxEvents: true,
                        selectable: true,
                        timeZone: 'UTC',
                        events: function (fetchInfo, successCallback, failureCallback) {
                            $.ajax({
                                url: "/api/events",
                                method: "GET",
                                success: function (data) {
                                    var events = data.map(function (event) {
                                        return {
                                            id: event.id,
                                            title: event.title,
                                            start: event.start,
                                            end: event.end,
                                            backgroundColor: event.backgroundColor
                                        };
                                    });
                                    successCallback(events);
                                },
                                error: function (error) {
                                    console.error('이벤트 가져오기 실패:', error);
                                    failureCallback(error);
                                }
                            });
                        },
                        select: function(info) {
                            $('#editEventModal').modal('show');

                            $('#editEventModalConfirm').off('click').on('click', function() {
                                var newTitle = $('#eventTitleInput').val();
                                var selectedColor = $('#eventColorSelect').val();

                                var startDate = info.start;
                                var endDate = info.end || startDate;

                                var eventData = {
                                    title: newTitle,
                                    start: startDate,
                                    end: endDate,
                                    backgroundColor: selectedColor // 사용자가 선택한 색상을 할당
                                };

                                // 추가: 서버에 새 이벤트 추가 요청
                                $.ajax({
                                    type: "POST",
                                    contentType: "application/json",
                                    url: "/api/events",
                                    data: JSON.stringify(eventData),
                                    success: function(response) {
                                        calendar.addEvent(response);
                                    },
                                    error: function(error) {
                                        console.error('이벤트 추가 실패:', error);
                                    }
                                });

                                $('#editEventModal').modal('hide');
                            });
                        },

                        eventClick: function(info) {
                            $('#editEventModal').modal('show');

                            $('#editEventModalConfirm').on('click', function() {
                                var newTitle = $('#eventTitleInput').val();

                                info.event.setProp('title', newTitle);

                                // 추가: 서버에 이벤트 수정 요청
                                $.ajax({
                                    type: "PUT",
                                    contentType: "application/json",
                                    url: "/api/events/" + info.event.id,
                                    data: JSON.stringify({
                                        title: newTitle,
                                        start: info.event.start,
                                        end: info.event.end,
                                    }),
                                    success: function(response) {
                                        // 서버에서 수정된 이벤트를 받아와 반영
                                        info.event.setProp('title', response.title);
                                        info.event.setStart(response.start);
                                        info.event.setEnd(response.end);
                                    },
                                    error: function(error) {
                                        console.error('이벤트 수정 실패:', error);
                                    }
                                });

                                $('#editEventModal').modal('hide');
                            });

                            $('#editEventModalDelete').off('click').on('click', function() {
                                // 선택된 이벤트를 삭제
                                if (info.event) {
                                    var eventId = info.event.extendedProps.id; // 이벤트의 ID 가져오기
                                    // 서버로 삭제 요청 보내기
                                    $.ajax({
                                        url: 'http://localhost:8080/api/events/' + info.event.id,
                                        type: 'DELETE',
                                        success: function() {
                                            // 삭제 성공 시 캘린더에서도 이벤트 제거
                                            info.event.remove();
                                            // 모달 창 닫기
                                            $('#editEventModal').modal('hide');
                                        },
                                        error: function() {
                                            // 삭제 실패 시 예외 처리

                                            alert('이벤트 삭제에 실패했습니다.');
                                        }
                                    });
                                }
                            });
                        }
                    });
                    calendar.render();
                });
            </script>

            <div class="row">
                <div class="col-md-12 mb-4">
                    <div class="card border-left-danger shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-l font-weight-bold text-danger text-uppercase mb-1">
                                        현재 날씨
                                        <p class="h5 mb-0 font-weight-bold text-gray-800">기온: <span
                                                id="temperature"></span>°C</p>
                                    </div>
                                    <div class="text-l font-weight-bold text-danger text-uppercase mb-1">
                                        <p class="h5 mb-0 font-weight-bold text-gray-800">위치: <span
                                                id="location"></span></p>
                                    </div>

                                    <script>
                                        const API_KEY = '6bfdb7b9b8dc3fab00065204dc3d7caa';

                                        function getWeather(lat, lon) {
                                            fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=kr`)
                                                .then(response => response.json())
                                                .then(data => {
                                                document.getElementById('temperature').textContent = data.main.temp;

                                                let locationName = data.name;
                                                if (locationName === 'Seryui-dong') {
                                                    locationName = '세류동';
                                                }
                                                if (locationName === 'Suwon-si') {
                                                    locationName = '수원시';
                                                }
                                                document.getElementById('location').textContent = locationName;
                                                document.getElementById('icon').src = "http://openweathermap.org/img/wn/" + data.weather[0].icon + "@2x.png";
                                            })
                                                .catch(error => {
                                                console.error('날씨 정보를 가져오는데 실패했습니다:', error);
                                            });
                                        }

                                        getWeather(37.2636, 127.0286);

                                        function getLocationAndWeather() {
                                            if (navigator.geolocation) {
                                                navigator.geolocation.getCurrentPosition((position) => {
                                                    getWeather(position.coords.latitude, position.coords.longitude);
                                                }, (error) => {
                                                    console.error('위치 정보를 가져오는데 실패했습니다:', error);
                                                });
                                            } else {
                                                console.error('이 브라우저에서는 지리적 위치를 지원하지 않습니다.');
                                            }
                                        }

                                        window.onload = getLocationAndWeather;

                                        // 시계 API
                                          const dpTime = function () {
                                          const now = new Date()
                                          let hours = now.getHours()
                                          let minutes = now.getMinutes()
                                          let seconds = now.getSeconds()
                                          let ampm = ''
                                          if (hours > 12) {
                                            hours -= 12
                                            ampm = '오후'
                                          } else {
                                            ampm = '오전'
                                          }
                                          if (hours < 10) {
                                            hours = '0' + hours
                                          }
                                          if (minutes < 10) {
                                            minutes = '0' + minutes
                                          }
                                          if (seconds < 10) {
                                            seconds = '0' + seconds
                                          }
                                          document.querySelector('#time').innerHTML = ampm + hours + ":" + minutes + ":" + seconds
                                        }
                                        setInterval(dpTime, 1000)  // 1초마다 함수 실행되도록 설정

                                    </script>
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    <div id="time"></div>
                                </div>
                                <div>
                                    <img src="" id="icon">
                                </div>

                            </div>
                        </div>
                    </div>
                </div>


            </div>


            <div class="col-md-12 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    판매 건수
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                     th:text="${estimateEntities.size()}+ '건'"></div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-handshake fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-md-12 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    구매 건수
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                     th:text="${orinPutEntities.size()}+'건'"></div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-md-12 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    생산
                                </div>
                                <div class="row no-gutters align-items-center">
                                    <div class="col-auto">
                                        <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">생산양</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-md-12 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    재고량
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">재고 수량</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-cubes fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>


    </div>
</div>



</body>
</html>